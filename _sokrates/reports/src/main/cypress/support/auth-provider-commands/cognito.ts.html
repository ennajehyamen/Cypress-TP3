<html>
<head>
    <title>cypress/support/auth-provider-commands/cognito.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">cypress/support/auth-provider-commands/cognito.ts (<b>76</b> lines of code) (<a href="cognito.ts">raw</a>):</h3>
<div id="editor">import { Amplify } from &quot;aws-amplify&quot;;
import { fetchAuthSession, signIn } from &quot;aws-amplify/auth&quot;;

Amplify.configure(Cypress.env(&quot;awsConfig&quot;));

const fetchJwts = async (username: string, password: string) =&gt; {
  const options = { authFlowType: &quot;USER_PASSWORD_AUTH&quot; as const };
  await signIn({ username, password, options });
  const authSession = await fetchAuthSession();
  const tokens = authSession.tokens!;
  const accessToken = tokens.accessToken;
  const accessTokenPayload = accessToken.payload;
  return {
    idToken: tokens.idToken!.toString(),
    accessToken: accessToken.toString(),
    clientId: accessTokenPayload.client_id as string,
    accessTokenSub: accessTokenPayload.sub!,
  };
};
type JwtResponse = Awaited&lt;ReturnType&lt;typeof fetchJwts&gt;&gt;;

// Amazon Cognito
Cypress.Commands.add(&quot;loginByCognitoApi&quot;, (username: string, password: string) =&gt; {
  const log = Cypress.log({
    displayName: &quot;COGNITO LOGIN&quot;,
    message: [`üîê Authenticating | ${username}`],
    autoEnd: false,
  });

  log.snapshot(&quot;before&quot;);

  cy.wrap(fetchJwts(username, password), { log: false }).then((unknownJwts) =&gt; {
    const { idToken, accessToken, clientId, accessTokenSub } = unknownJwts as JwtResponse;

    const keyPrefix = `CognitoIdentityServiceProvider.${clientId}`;
    const keyPrefixWithUsername = `${keyPrefix}.${accessTokenSub}`;

    const ls = window.localStorage;
    ls.setItem(`${keyPrefixWithUsername}.idToken`, idToken);
    ls.setItem(`${keyPrefixWithUsername}.accessToken`, accessToken);
    ls.setItem(`${keyPrefix}.LastAuthUser`, accessTokenSub);

    log.snapshot(&quot;after&quot;);
    log.end();
  });

  cy.visit(&quot;/&quot;);
});

// Amazon Cognito
Cypress.Commands.add(&quot;loginByCognito&quot;, (username, password) =&gt; {
  cy.session(
    `cognito-${username}`,
    () =&gt; {
      Cypress.log({
        displayName: &quot;COGNITO LOGIN&quot;,
        message: [`üîê Authenticating | ${username}`],
        // @ts-ignore
        autoEnd: false,
      });

      cy.visit(&quot;/&quot;);

      cy.origin(
        Cypress.env(&quot;cognito_domain&quot;),
        {
          args: {
            username,
            password,
          },
        },
        ({ username, password }) =&gt; {
          cy.contains(&quot;Sign in with your email and password&quot;);
          // cognito log in page has some elements of the same id but are off screen. we only want the visible elements to log in
          cy.get('input[name=&quot;username&quot;]:visible').type(username);
          cy.get('input[name=&quot;password&quot;]:visible').type(password, {
            log: false,
          });
          cy.get('input[name=&quot;signInSubmitButton&quot;]:visible').click();
        }
      );

      // give a few seconds for redirect to settle
      // eslint-disable-next-line cypress/no-unnecessary-waiting
      cy.wait(2000);

      // verify we have made it passed the login screen
      cy.contains(&quot;Get Started&quot;).should(&quot;be.visible&quot;);
    },
    {
      validate() {
        cy.visit(&quot;/&quot;);
        /**
         * NOTE: We recommend validating sessions by either validating
         * localStorage or cookies values, or possibly accessing an
         * endpoint to validate that the correct user is logged.
         *
         * This example is here for brevity to make sure
         * our user is directly taken to the onboarding flow
         * and not blocked by a login screen
         */
        // revalidate our session to make sure we are logged in
        cy.contains(&quot;Get Started&quot;).should(&quot;be.visible&quot;);
      },
    }
  );
});
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
