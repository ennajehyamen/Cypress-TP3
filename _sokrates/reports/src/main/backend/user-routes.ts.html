<html>
<head>
    <title>backend/user-routes.ts</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend/user-routes.ts (<b>70</b> lines of code) (<a href="user-routes.ts">raw</a>):</h3>
<div id="editor">///&lt;reference path=&quot;types.ts&quot; /&gt;

import express from &quot;express&quot;;
import { isEqual, pick } from &quot;lodash/fp&quot;;

import {
  getAllUsers,
  createUser,
  updateUserById,
  getUserById,
  getUserByUsername,
  searchUsers,
  removeUserFromResults,
} from &quot;./database&quot;;
import { User } from &quot;../src/models/user&quot;;
import { ensureAuthenticated, validateMiddleware } from &quot;./helpers&quot;;
import {
  shortIdValidation,
  searchValidation,
  userFieldsValidator,
  isUserValidator,
} from &quot;./validators&quot;;
const router = express.Router();

// Routes
router.get(&quot;/&quot;, ensureAuthenticated, (req, res) =&gt; {
  /* istanbul ignore next */
  const users = removeUserFromResults(req.user?.id!, getAllUsers());
  res.status(200).json({ results: users });
});

router.get(&quot;/search&quot;, ensureAuthenticated, validateMiddleware([searchValidation]), (req, res) =&gt; {
  const { q } = req.query;

  /* istanbul ignore next */
  const users = removeUserFromResults(req.user?.id!, searchUsers(q as string));

  res.status(200).json({ results: users });
});

router.post(&quot;/&quot;, userFieldsValidator, validateMiddleware(isUserValidator), (req, res) =&gt; {
  const userDetails: User = req.body;

  const user = createUser(userDetails);

  res.status(201);
  res.json({ user: user });
});

router.get(
  &quot;/:userId&quot;,
  ensureAuthenticated,
  validateMiddleware([shortIdValidation(&quot;userId&quot;)]),
  (req, res) =&gt; {
    const { userId } = req.params;

    // Permission: account owner
    /* istanbul ignore next */
    if (!isEqual(userId, req.user?.id)) {
      return res.status(401).send({
        error: &quot;Unauthorized&quot;,
      });
    }

    const user = getUserById(userId);

    res.status(200);
    res.json({ user });
  }
);

router.get(&quot;/profile/:username&quot;, (req, res) =&gt; {
  const { username } = req.params;

  const user = pick([&quot;firstName&quot;, &quot;lastName&quot;, &quot;avatar&quot;], getUserByUsername(username));

  res.status(200);
  res.json({ user });
});

router.patch(
  &quot;/:userId&quot;,
  ensureAuthenticated,
  userFieldsValidator,
  validateMiddleware([shortIdValidation(&quot;userId&quot;), ...isUserValidator]),
  (req, res) =&gt; {
    const { userId } = req.params;

    const edits: User = req.body;

    updateUserById(userId, edits);

    res.sendStatus(204);
  }
);

export default router;
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/typescript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
